name: Workflow CI/CD Model ML (Final)
on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    name: ğŸš€ Build, Test, and Deploy ML Model
    runs-on: ubuntu-latest
    timeout-minutes: 25

    env:
      # Pastikan secrets ini sudah di-set di repository GitHub Anda
      MLFLOW_TRACKING_URI: https://dagshub.com/${{ secrets.DAGSHUB_USERNAME }}/smsml_tema.mlflow
      MLFLOW_TRACKING_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
      MLFLOW_TRACKING_PASSWORD: ${{ secrets.DAGSHUB_TOKEN }}

    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Conda with environment from file
        uses: conda-incubator/setup-miniconda@v3
        with:
          environment-file: MLProject/conda.yaml
          activate-environment: mlflow-tensorflow-env
          auto-activate-base: false

      - name: ğŸƒ Run MLflow project to train model
        shell: bash -l {0}
        run: |
          cd MLProject
          mlflow run . --experiment-id 0 -P epochs=5

      - name: ğŸ†” Get MLflow run_id from file
        id: get_run_id
        shell: bash -l {0}
        run: |
          RUN_ID_FILE="MLProject/run_id.txt"
          if [ ! -f "$RUN_ID_FILE" ]; then echo "âŒ File run_id.txt not found!"; exit 1; fi
          RUN_ID=$(cat $RUN_ID_FILE)
          if [[ -z "$RUN_ID" ]]; then echo "âŒ Failed to read run ID from file!"; exit 1; fi
          echo "âœ… Run ID from file: $RUN_ID"
          echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV

      # --- PERUBAHAN UTAMA DI SINI ---
      # Kita tidak lagi mengunduh artefak secara manual.
      # Perintah build-docker akan mengambilnya langsung dari DagsHub.
      - name: ğŸ³ Build Docker Image from Model URI
        shell: bash -l {0}
        run: |
          echo "Building Docker image from model URI: runs:/${RUN_ID}/model"
          # Perintah ini memberitahu MLflow untuk mengambil model langsung dari server
          mlflow models build-docker -m "runs:/${RUN_ID}/model" -n smsml-model --enable-mlserver

      - name: ğŸ” Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸš¢ Push Docker Image to Docker Hub
        run: |
          docker tag smsml-model:latest ${{ secrets.DOCKERHUB_USERNAME }}/smsml-model:latest
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/smsml-model:latest

      - name: ğŸ”“ Logout from Docker Hub
        run: docker logout
