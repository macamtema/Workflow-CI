name: Full Training and Deployment Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  train-build-deploy:
    name: Train, Commit, Build, and Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 360

    permissions:
      contents: write
      pull-requests: write

    env:
      DAGSHUB_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
      DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
      MLFLOW_TRACKING_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
      MLFLOW_TRACKING_PASSWORD: ${{ secrets.DAGSHUB_TOKEN }}

    steps:
      - name: 1. Checkout Repository
        uses: actions/checkout@v4

      - name: 2. Set up Python and Install Dependencies
        uses: conda-incubator/setup-miniconda@v3
        with:
          python-version: "3.12"
          auto-activate-base: false
          activate-environment: ""
      - run: |
          echo "--- Installing Python packages ---"
          python -m pip install --upgrade pip
          pip install tensorflow numpy scikit-learn mlflow==2.10.2 dagshub
        shell: bash -l {0}

      - name: 3. Check Env
        shell: bash -l {0}
        run: |
          echo "--- Environment Check ---"
          python --version
          pip list

      - name: 4. Run Training Script
        run: |
          cd MLProject
          python modelling.py --epochs 10
        shell: bash -l {0}

      - name: 5. Get latest MLflow run_id
        id: get_run_id
        shell: bash
        run: |
          # Dapatkan run_id terbaru dari DagsHub karena autolog tidak menulis file run_id.txt
          echo "Fetching latest run_id from DagsHub..."
          RUN_ID=$(mlflow runs list --experiment-id 0 --query "tags.mlflow.source.type = 'LOCAL'" | awk 'NR==2 {print $1}')
          if [[ -z "$RUN_ID" ]]; then echo "❌ Failed to get Run ID!"; exit 1; fi
          echo "✅ Trained Model Run ID: $RUN_ID"
          echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV

      - name: 6. Download All Artifacts from MLflow
        run: |
          echo "Downloading all artifacts from run ${{ env.RUN_ID }}"
          mlflow artifacts download --run-id ${{ env.RUN_ID }} -d ./artifacts_temp
          echo "✅ Artifacts downloaded. Contents:"
          ls -R ./artifacts_temp
        shell: bash -l {0}

      # =================================================================
      # === PERBAIKAN FINAL: PROSES DIPISAH MENJADI DUA LANGKAH =======
      # =================================================================
      - name: 7a. Prepare Artifact for Commit
        run: |
          echo "Preparing artifact folder for commit..."
          # Hapus folder lama dan buat yang baru untuk memastikan kebersihan
          rm -rf MLProject/model_artifact/
          mkdir -p MLProject/model_artifact/
          # Salin artefak model yang baru diunduh ke dalamnya
          cp -r artifacts_temp/model/* MLProject/model_artifact/

      - name: 7b. Upload artefak to MLProject (Create PR)
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PAT }}
          commit-message: "ci: Update trained model artifact"
          author: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
          branch: "update/latest-model-artifact"
          base: main
          title: "[Automated] Update Trained Model Artifact"
          body: |
            A new model has been trained. This PR places the new artifact into the `MLProject/model_artifact` folder.
            - **MLflow Run ID:** `${{ env.RUN_ID }}`
          # Menentukan path yang akan di-commit
          add-paths: MLProject/model_artifact/
          # Parameter pre-commit-script yang salah sudah dihapus

      - name: 8. Build Docker Model
        run: |
          echo "Preparing files for Docker build..."
          mkdir -p environment_files/environment
          mkdir -p downloaded_model
          cp artifacts_temp/conda.yaml environment_files/environment/conda.yaml
          cp -r artifacts_temp/model/* downloaded_model/model/
          echo "Building Docker image..."
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/smsml-model:latest -f Dockerfile .

      - name: 9. Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: 10. Push Docker Image
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/smsml-model:latest

      - name: 11. Complete job
        run: echo "Workflow completed successfully."
