name: Train, Deploy, and Archive Model CI/CD

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-and-deploy:
    name: üöÄ Build, Deploy, and Archive ML Model
    runs-on: ubuntu-latest
    timeout-minutes: 45

    permissions:
      contents: write
      pull-requests: write

    env:
      MLFLOW_TRACKING_URI: https://dagshub.com/${{ secrets.DAGSHUB_USERNAME }}/smsml_tema.mlflow
      MLFLOW_TRACKING_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
      MLFLOW_TRACKING_PASSWORD: ${{ secrets.DAGSHUB_TOKEN }}

    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4
        with:
          # Kita butuh PAT di sini agar langkah 'create-pull-request' bisa mendorong perubahan
          token: ${{ secrets.PAT }}

      - name: üêç Setup Conda with environment
        uses: conda-incubator/setup-miniconda@v3
        with:
          environment-file: MLProject/conda.yaml
          activate-environment: mlflow-tensorflow-env
          auto-activate-base: false

      - name: üèÉ Run MLflow project to train model
        shell: bash -l {0}
        run: |
          cd MLProject
          # Menjalankan dengan 5 epoch untuk menjaga agar tidak terlalu lama
          mlflow run . --experiment-id 0 -P epochs=5 --env-manager=local

      - name: üÜî Get MLflow run_id from file
        id: get_run_id
        shell: bash -l {0}
        run: |
          RUN_ID_FILE="MLProject/run_id.txt"
          if [ ! -f "$RUN_ID_FILE" ]; then echo "‚ùå File run_id.txt not found!"; exit 1; fi
          RUN_ID=$(cat $RUN_ID_FILE)
          if [[ -z "$RUN_ID" ]]; then echo "‚ùå Failed to read run ID from file!"; exit 1; fi
          echo "‚úÖ Run ID from file: $RUN_ID"
          echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV

      - name: üì• Download Environment Artifact
        shell: bash -l {0}
        run: |
          mlflow artifacts download --run-id $RUN_ID --artifact-path environment -d ./environment_files

      - name: üì• Download Model Artifact
        shell: bash -l {0}
        run: |
          mlflow artifacts download --run-id $RUN_ID --artifact-path model -d ./downloaded_model

      - name: üê≥ Build Docker Image using custom Dockerfile
        run: |
          docker build -t smsml-model -f Dockerfile .

      - name: üîê Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: üö¢ Push Docker Image to Docker Hub
        run: |
          docker tag smsml-model:latest ${{ secrets.DOCKERHUB_USERNAME }}/smsml-model:latest
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/smsml-model:latest

      # =====================================================================
      # === LANGKAH TAMBAHAN: SIMPAN ARTEFAK KE REPOSITORI =================
      # =====================================================================
      - name: Create Pull Request with Artifacts
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PAT }}
          commit-message: "ci: Archive trained model artifacts for run ${{ env.RUN_ID }}"
          author: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
          branch: "archive/model-artifacts-${{ env.RUN_ID }}"
          title: "[Automated] Archive Model Artifacts for Run ${{ env.RUN_ID }}"
          body: |
            This PR archives the ML model and environment artifacts from a successful training run.
            - **Run ID:** `${{ env.RUN_ID }}`
            - **Contents:** `downloaded_model/` and `environment_files/`
          delete-branch: true
